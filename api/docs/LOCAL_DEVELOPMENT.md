# Local Development Guide

## Overview

This guide explains how to run the Oriana Order Tracking API locally using AWS SAM CLI.

## Configuration Architecture

| Config Type | Local (SAM) | AWS (dev/qa/prod) |
|-------------|-------------|-------------------|
| Database connection (host, port, name) | `env.local.json` | Lambda env vars (CDK) |
| Database credentials (user, password) | `env.local.json` | AWS Secrets Manager (`/oriana/{env}/db`) |
| JWT secrets | `env.local.json` | AWS Secrets Manager (`/oriana/{env}/jwt`) |
| JWT expiry times | `env.local.json` | Lambda env vars (CDK) |

**Note**: `env.local.json` is **only for local SAM testing**. In AWS:
- Non-sensitive config (expiry times, host, port) → Lambda environment variables via CDK
- Sensitive secrets (passwords, JWT secrets) → Fetched at runtime from AWS Secrets Manager with 5-minute caching

## Prerequisites

- Node.js 22+
- Docker Desktop running
- AWS SAM CLI installed
- PostgreSQL database (Supabase recommended)

## Quick Start

### 1. Set Up Local Environment

```bash
cd cdk
cp env.template.json env.local.json
```

Edit `env.local.json` with your database and JWT credentials:

```json
{
  "oriana-po-dev": {
    "ENVIRONMENT": "dev",
    "IS_LOCAL": "true",
    "DB_HOST": "db.xxxxxxxxxxxx.supabase.co",
    "DB_PORT": "5432",
    "DB_NAME": "postgres",
    "DB_USERNAME": "postgres",
    "DB_PASSWORD": "your-supabase-password",
    "DB_SSL": "true",
    "LOG_LEVEL": "DEBUG",
    "JWT_SECRET": "your-local-dev-jwt-secret-at-least-32-chars",
    "JWT_REFRESH_SECRET": "your-local-dev-refresh-secret-at-least-32-chars",
    "JWT_EXPIRES_IN": "15m",
    "JWT_REFRESH_EXPIRES_IN": "1d"
  }
}
```

### JWT Configuration

| Variable | Description | Example |
|----------|-------------|---------|
| `JWT_SECRET` | Secret for signing access tokens | Random 32+ character string |
| `JWT_REFRESH_SECRET` | Secret for signing refresh tokens | Random 32+ character string |
| `JWT_EXPIRES_IN` | Access token expiry | `15m`, `30m`, `1h` |
| `JWT_REFRESH_EXPIRES_IN` | Refresh token expiry | `1d`, `7d`, `30d` |

For local development, you can use simple strings. For production, use strong random secrets (64+ characters).

### 2. Build the Project

```bash
cd api
npm run build:all
```

### 3. Start Local API

```bash
cd cdk
npm run dev
```

The API will be available at `http://127.0.0.1:3000`

## Database Setup with Supabase

1. Create a Supabase project at https://supabase.com
2. Go to **Settings > Database** to find connection info
3. Copy the connection details to `env.local.json`

## NPM Scripts

| Script | Description |
|--------|-------------|
| `npm run dev` | Start SAM local API |
| `npm run dev:fresh` | Clean build and start |
| `npm run dev:debug` | Start with debug logging |
| `npm run dev:quick` | Quick start (no API rebuild) |
| `npm run dev:port` | Start with custom port (set `API_PORT` env var) |
| `npm run dev:watch` | Start with hot reload on code changes |
| `npm run dev:all` | Start with both API watch and SAM hot reload |

## Troubleshooting

### "connect ECONNREFUSED" Error

Database connection failed. Check:
1. Database credentials in `env.local.json`
2. Database is running and accessible
3. For Supabase, verify `DB_SSL: "true"`

### Function Name in env.local.json

The key must match SAM's logical ID. Find it in `cdk.out/ApiStack-dev.template.json` or SAM output.

## Security

- **Never commit** `env.local.json` to Git (it's in `.gitignore`)
- Only `env.template.json` is committed (contains placeholder values)
- AWS deployments use Secrets Manager for sensitive credentials:
  - `/oriana/{env}/db` - Database username and password
  - `/oriana/{env}/jwt` - JWT_SECRET and JWT_REFRESH_SECRET (auto-generated by CDK)
- **JWT secrets are automatically generated** during CDK deployment - no manual setup needed!
- Secrets are fetched at runtime with 5-minute caching to minimize API calls
- Production enforces that secrets must be present (throws error if missing)
