# Database Seed Admin Workflow
#
# This workflow seeds the first admin user in the production database.
# Use this for initial setup after deploying to a new environment.
#
# Trigger: Manual dispatch with environment selection
#
# Required GitHub Secrets:
#   - AWS_ACCESS_KEY_ID: AWS access key with deployment permissions
#   - AWS_SECRET_ACCESS_KEY: AWS secret access key
#   - AWS_REGION: AWS region (e.g., ap-south-1)
#
# For dev/qa with external DB (Neon/Supabase), also set:
#   - DATABASE_URL_DEV: Full Prisma connection string for dev
#   - DATABASE_URL_QA: Full Prisma connection string for qa

name: ðŸŒ± Seed Admin User

on:
  workflow_dispatch:
    inputs:
      environment:
        description: 'Environment to seed'
        required: true
        type: choice
        options:
          - dev
          - qa
          - prod
      admin_username:
        description: 'Admin username (default: admin)'
        required: false
        type: string
        default: 'admin'
      admin_email:
        description: 'Admin email (default: admin@oriana.com)'
        required: false
        type: string
        default: 'admin@oriana.com'
      admin_password:
        description: 'Admin password (default: Admin@123)'
        required: false
        type: string
        default: 'Admin@123'
      confirm_prod:
        description: 'Type "SEED-PROD" to confirm production seeding'
        required: false
        type: string
        default: ''

# Prevent concurrent seeds to the same environment
concurrency:
  group: seed-${{ github.event.inputs.environment }}
  cancel-in-progress: false

env:
  NODE_VERSION: '20'
  AWS_REGION: ${{ secrets.AWS_REGION || 'ap-south-1' }}

jobs:
  # Validate production confirmation
  validate-prod:
    name: Validate Production Confirmation
    if: github.event.inputs.environment == 'prod'
    runs-on: ubuntu-latest
    steps:
      - name: âš ï¸ Validate Production Confirmation
        if: github.event.inputs.confirm_prod != 'SEED-PROD'
        run: |
          echo "âŒ Production seeding requires confirmation!"
          echo "Please type 'SEED-PROD' in the confirmation field."
          exit 1

      - name: âœ… Production Confirmed
        if: github.event.inputs.confirm_prod == 'SEED-PROD'
        run: echo "âœ… Production seeding confirmed by @${{ github.actor }}"

  seed:
    name: Seed ${{ github.event.inputs.environment }}
    runs-on: ubuntu-latest
    needs: [validate-prod]
    if: always() && (needs.validate-prod.result == 'success' || needs.validate-prod.result == 'skipped')
    environment: ${{ github.event.inputs.environment }}

    steps:
      - name: ðŸ“¥ Checkout code
        uses: actions/checkout@v4

      - name: ðŸ“¦ Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: 'npm'
          cache-dependency-path: api/package-lock.json

      - name: ðŸ”‘ Configure AWS credentials
        uses: aws-actions/configure-aws-credentials@v4
        with:
          aws-access-key-id: ${{ secrets.AWS_ACCESS_KEY_ID }}
          aws-secret-access-key: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
          aws-region: ${{ env.AWS_REGION }}

      - name: ðŸ“¦ Install API dependencies
        working-directory: api
        run: npm ci

      # ===== DEV ENVIRONMENT =====
      - name: ðŸŒ± Seed Admin (Dev)
        if: github.event.inputs.environment == 'dev'
        working-directory: api
        run: npm run db:seed:admin
        env:
          DATABASE_URL: ${{ secrets.DATABASE_URL_DEV }}
          ADMIN_USERNAME: ${{ github.event.inputs.admin_username }}
          ADMIN_EMAIL: ${{ github.event.inputs.admin_email }}
          ADMIN_PASSWORD: ${{ github.event.inputs.admin_password }}

      # ===== QA ENVIRONMENT =====
      - name: ðŸŒ± Seed Admin (QA)
        if: github.event.inputs.environment == 'qa'
        working-directory: api
        run: npm run db:seed:admin
        env:
          DATABASE_URL: ${{ secrets.DATABASE_URL_QA }}
          ADMIN_USERNAME: ${{ github.event.inputs.admin_username }}
          ADMIN_EMAIL: ${{ github.event.inputs.admin_email }}
          ADMIN_PASSWORD: ${{ github.event.inputs.admin_password }}

      # ===== PRODUCTION ENVIRONMENT (AWS RDS) =====
      - name: ðŸ” Get RDS Endpoint (Prod)
        if: github.event.inputs.environment == 'prod'
        id: rds
        run: |
          ENDPOINT=$(aws cloudformation describe-stacks \
            --stack-name ApiStack-prod \
            --query "Stacks[0].Outputs[?ExportName=='Oriana-RDS-Endpoint-prod'].OutputValue" \
            --output text)
          echo "endpoint=$ENDPOINT" >> $GITHUB_OUTPUT
          echo "ðŸ“¡ RDS Endpoint: $ENDPOINT"

      - name: ðŸŒ± Seed Admin (Prod)
        if: github.event.inputs.environment == 'prod'
        working-directory: api
        run: npm run db:seed:admin
        env:
          DB_SECRET_ID: /oriana/prod/db
          DB_HOST: ${{ steps.rds.outputs.endpoint }}
          DB_NAME: oriana
          ADMIN_USERNAME: ${{ github.event.inputs.admin_username }}
          ADMIN_EMAIL: ${{ github.event.inputs.admin_email }}
          ADMIN_PASSWORD: ${{ github.event.inputs.admin_password }}

      - name: ðŸ“‹ Seed Summary
        run: |
          echo "## ðŸŒ± Admin Seed Complete!" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "| Setting | Value |" >> $GITHUB_STEP_SUMMARY
          echo "|---------|-------|" >> $GITHUB_STEP_SUMMARY
          echo "| Environment | \`${{ github.event.inputs.environment }}\` |" >> $GITHUB_STEP_SUMMARY
          echo "| Username | \`${{ github.event.inputs.admin_username }}\` |" >> $GITHUB_STEP_SUMMARY
          echo "| Email | \`${{ github.event.inputs.admin_email }}\` |" >> $GITHUB_STEP_SUMMARY
          echo "| Triggered by | @${{ github.actor }} |" >> $GITHUB_STEP_SUMMARY
          echo "| Timestamp | $(date -u) |" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "âš ï¸ **Remember to change the password after first login!**" >> $GITHUB_STEP_SUMMARY

