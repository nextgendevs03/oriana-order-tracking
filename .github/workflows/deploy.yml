# Deployment Workflow for Oriana Order Tracking
#
# This workflow deploys the application to AWS based on the selected environment.
# For full deployments, it uses a two-phase approach:
#   1. Deploy API first to get the API URL
#   2. Build UI with the correct API URL
#   3. Upload UI to S3 and invalidate CloudFront cache
#
# Trigger: Manual dispatch with environment selection
#
# Required GitHub Secrets:
#   - AWS_ACCESS_KEY_ID: AWS access key with deployment permissions
#   - AWS_SECRET_ACCESS_KEY: AWS secret access key
#   - AWS_REGION: AWS region (e.g., ap-south-1)

name: üöÄ Deploy

on:
  workflow_dispatch:
    inputs:
      environment:
        description: 'Environment to deploy'
        required: true
        type: choice
        options:
          - dev
          - qa
          - prod
      deploy_type:
        description: 'What to deploy'
        required: true
        type: choice
        options:
          - full        # API + UI (two-phase deployment)
          - api-only    # API only (faster)
      skip_ui_build:
        description: 'Skip UI build (use existing)'
        required: false
        type: boolean
        default: false

# Prevent concurrent deployments to the same environment
concurrency:
  group: deploy-${{ github.event.inputs.environment }}
  cancel-in-progress: false

env:
  NODE_VERSION: '22'
  AWS_REGION: ${{ secrets.AWS_REGION || 'ap-south-1' }}

jobs:
  deploy:
    name: Deploy to ${{ github.event.inputs.environment }}
    runs-on: ubuntu-latest
    environment: ${{ github.event.inputs.environment }}

    steps:
      - name: üì• Checkout code
        uses: actions/checkout@v4

      - name: üì¶ Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: 'npm'
          cache-dependency-path: |
            api/package-lock.json
            cdk/package-lock.json
            ui/package-lock.json

      - name: üîë Configure AWS credentials
        uses: aws-actions/configure-aws-credentials@v4
        with:
          aws-access-key-id: ${{ secrets.AWS_ACCESS_KEY_ID }}
          aws-secret-access-key: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
          aws-region: ${{ env.AWS_REGION }}

      - name: üì¶ Install API dependencies
        working-directory: api
        run: npm ci

      - name: üì¶ Install CDK dependencies
        working-directory: cdk
        run: npm ci

      - name: üî® Build API
        working-directory: api
        run: npm run build:all

      # ============================================
      # PHASE 1: Deploy API (for full deployment)
      # ============================================
      - name: üöÄ Phase 1 - Deploy API Infrastructure
        if: github.event.inputs.deploy_type == 'full'
        working-directory: cdk
        run: |
          echo "üöÄ Phase 1: Deploying API infrastructure to ${{ github.event.inputs.environment }}..."
          npx cdk deploy ApiStack-${{ github.event.inputs.environment }} --require-approval never --outputs-file cdk-outputs.json

      - name: üîó Get API URL from Stack Outputs
        if: github.event.inputs.deploy_type == 'full'
        id: get_api_url
        working-directory: cdk
        run: |
          STACK_NAME="ApiStack-${{ github.event.inputs.environment }}"
          
          echo "üìÑ Looking for API URL in stack outputs..."
          
          # Try to get from CDK outputs file first (CDK prefixes with construct ID)
          if [ -f cdk-outputs.json ]; then
            echo "Found cdk-outputs.json:"
            cat cdk-outputs.json
            
            # Look for any key containing "ApiUrl" (CDK adds construct prefix)
            API_URL=$(jq -r ".[\"$STACK_NAME\"] | to_entries[] | select(.key | contains(\"ApiUrl\")) | .value" cdk-outputs.json 2>/dev/null | head -1)
          fi
          
          # Fallback to CloudFormation if not found
          if [ -z "$API_URL" ]; then
            echo "Fetching from CloudFormation..."
            # Look for any output key containing "ApiUrl"
            API_URL=$(aws cloudformation describe-stacks --stack-name $STACK_NAME \
              --query "Stacks[0].Outputs[?contains(OutputKey, 'ApiUrl')].OutputValue" --output text 2>/dev/null | head -1 || echo "")
          fi
          
          if [ -n "$API_URL" ] && [ "$API_URL" != "None" ] && [ "$API_URL" != "" ]; then
            # Remove trailing slash if present
            API_URL="${API_URL%/}"
            echo "api_url=${API_URL}" >> $GITHUB_OUTPUT
            echo "‚úÖ API URL for UI build: ${API_URL}"
          else
            echo "‚ùå Could not retrieve API URL from stack outputs"
            echo "Available outputs:"
            aws cloudformation describe-stacks --stack-name $STACK_NAME --query "Stacks[0].Outputs[*].[OutputKey,OutputValue]" --output table || true
            exit 1
          fi

      # ============================================
      # PHASE 2: Build UI with correct API URL
      # ============================================
      - name: üì¶ Install UI dependencies
        if: github.event.inputs.deploy_type == 'full' && github.event.inputs.skip_ui_build == 'false'
        working-directory: ui
        run: npm ci

      - name: üî® Phase 2 - Build UI with API URL
        if: github.event.inputs.deploy_type == 'full' && github.event.inputs.skip_ui_build == 'false'
        working-directory: ui
        run: |
          echo "üî® Building UI with API URL: ${{ steps.get_api_url.outputs.api_url }}"
          npm run build
        env:
          CI: false  # Ignore warnings as errors
          REACT_APP_API_URL: ${{ steps.get_api_url.outputs.api_url }}

      # ============================================
      # PHASE 3: Upload UI to S3 & Invalidate Cache
      # ============================================
      - name: üîó Get S3 Bucket and CloudFront Info
        if: github.event.inputs.deploy_type == 'full' && github.event.inputs.skip_ui_build == 'false'
        id: get_ui_info
        working-directory: cdk
        run: |
          STACK_NAME="ApiStack-${{ github.event.inputs.environment }}"
          
          # Get from CDK outputs file (CDK prefixes with construct ID)
          if [ -f cdk-outputs.json ]; then
            BUCKET_NAME=$(jq -r ".[\"$STACK_NAME\"] | to_entries[] | select(.key | contains(\"BucketName\")) | .value" cdk-outputs.json 2>/dev/null | head -1)
            DISTRIBUTION_ID=$(jq -r ".[\"$STACK_NAME\"] | to_entries[] | select(.key | contains(\"DistributionId\")) | .value" cdk-outputs.json 2>/dev/null | head -1)
            WEBSITE_URL=$(jq -r ".[\"$STACK_NAME\"] | to_entries[] | select(.key | contains(\"WebsiteURL\")) | .value" cdk-outputs.json 2>/dev/null | head -1)
          fi
          
          # Fallback to CloudFormation
          if [ -z "$BUCKET_NAME" ] || [ "$BUCKET_NAME" == "null" ]; then
            BUCKET_NAME=$(aws cloudformation describe-stacks --stack-name $STACK_NAME \
              --query "Stacks[0].Outputs[?contains(OutputKey, 'BucketName')].OutputValue" --output text 2>/dev/null | head -1 || echo "")
          fi
          if [ -z "$DISTRIBUTION_ID" ] || [ "$DISTRIBUTION_ID" == "null" ]; then
            DISTRIBUTION_ID=$(aws cloudformation describe-stacks --stack-name $STACK_NAME \
              --query "Stacks[0].Outputs[?contains(OutputKey, 'DistributionId')].OutputValue" --output text 2>/dev/null | head -1 || echo "")
          fi
          if [ -z "$WEBSITE_URL" ] || [ "$WEBSITE_URL" == "null" ]; then
            WEBSITE_URL=$(aws cloudformation describe-stacks --stack-name $STACK_NAME \
              --query "Stacks[0].Outputs[?contains(OutputKey, 'WebsiteURL')].OutputValue" --output text 2>/dev/null | head -1 || echo "")
          fi
          
          echo "bucket_name=$BUCKET_NAME" >> $GITHUB_OUTPUT
          echo "distribution_id=$DISTRIBUTION_ID" >> $GITHUB_OUTPUT
          echo "website_url=$WEBSITE_URL" >> $GITHUB_OUTPUT
          
          echo "üì¶ S3 Bucket: $BUCKET_NAME"
          echo "üåê CloudFront Distribution: $DISTRIBUTION_ID"
          echo "üîó Website URL: $WEBSITE_URL"

      - name: üì§ Phase 3 - Upload UI to S3
        if: github.event.inputs.deploy_type == 'full' && github.event.inputs.skip_ui_build == 'false'
        run: |
          echo "üì§ Uploading UI build to S3..."
          aws s3 sync ui/build/ s3://${{ steps.get_ui_info.outputs.bucket_name }}/ \
            --delete \
            --cache-control "public, max-age=31536000, immutable" \
            --exclude "index.html" \
            --exclude "*.json"
          
          # Upload index.html and JSON files with no-cache
          aws s3 cp ui/build/index.html s3://${{ steps.get_ui_info.outputs.bucket_name }}/index.html \
            --cache-control "no-cache, no-store, must-revalidate"
          
          # Upload other JSON files if they exist
          if ls ui/build/*.json 1> /dev/null 2>&1; then
            for file in ui/build/*.json; do
              aws s3 cp "$file" s3://${{ steps.get_ui_info.outputs.bucket_name }}/$(basename "$file") \
                --cache-control "no-cache, no-store, must-revalidate"
            done
          fi
          
          echo "‚úÖ UI uploaded successfully!"

      - name: üîÑ Invalidate CloudFront Cache
        if: github.event.inputs.deploy_type == 'full' && github.event.inputs.skip_ui_build == 'false'
        run: |
          echo "üîÑ Invalidating CloudFront cache..."
          INVALIDATION_ID=$(aws cloudfront create-invalidation \
            --distribution-id ${{ steps.get_ui_info.outputs.distribution_id }} \
            --paths "/*" \
            --query 'Invalidation.Id' \
            --output text)
          echo "‚úÖ Cache invalidation started: $INVALIDATION_ID"

      # ============================================
      # API-ONLY DEPLOYMENT (simpler flow)
      # ============================================
      - name: üöÄ Deploy to AWS (API Only)
        if: github.event.inputs.deploy_type == 'api-only'
        working-directory: cdk
        run: |
          echo "üöÄ Deploying API only to ${{ github.event.inputs.environment }}..."
          npx cdk deploy ApiStack-${{ github.event.inputs.environment }} --require-approval never --outputs-file cdk-outputs.json

      # ============================================
      # EXTRACT FINAL URLs FOR SUMMARY
      # ============================================
      - name: üîó Extract Deployment URLs
        id: urls
        working-directory: cdk
        run: |
          STACK_NAME="ApiStack-${{ github.event.inputs.environment }}"
          
          # Extract URLs from CDK outputs file (CDK prefixes with construct ID)
          if [ -f cdk-outputs.json ]; then
            echo "üìÑ CDK Outputs:"
            cat cdk-outputs.json
            
            # Extract API URL (look for key containing "ApiUrl")
            API_URL=$(jq -r ".[\"$STACK_NAME\"] | to_entries[] | select(.key | contains(\"ApiUrl\")) | .value" cdk-outputs.json 2>/dev/null | head -1)
            if [ -n "$API_URL" ] && [ "$API_URL" != "null" ]; then
              echo "api_url=$API_URL" >> $GITHUB_OUTPUT
              echo "‚úÖ API URL: $API_URL"
            fi
            
            # Extract CloudFront URL (look for key containing "WebsiteURL")
            WEBSITE_URL=$(jq -r ".[\"$STACK_NAME\"] | to_entries[] | select(.key | contains(\"WebsiteURL\")) | .value" cdk-outputs.json 2>/dev/null | head -1)
            if [ -n "$WEBSITE_URL" ] && [ "$WEBSITE_URL" != "null" ]; then
              echo "website_url=$WEBSITE_URL" >> $GITHUB_OUTPUT
              echo "‚úÖ Website URL: $WEBSITE_URL"
            fi
          else
            echo "‚ö†Ô∏è CDK outputs file not found, fetching from CloudFormation..."
            
            # Fallback: Get from CloudFormation directly (look for keys containing the patterns)
            API_URL=$(aws cloudformation describe-stacks --stack-name $STACK_NAME \
              --query "Stacks[0].Outputs[?contains(OutputKey, 'ApiUrl')].OutputValue" --output text 2>/dev/null | head -1 || echo "")
            WEBSITE_URL=$(aws cloudformation describe-stacks --stack-name $STACK_NAME \
              --query "Stacks[0].Outputs[?contains(OutputKey, 'WebsiteURL')].OutputValue" --output text 2>/dev/null | head -1 || echo "")
            
            if [ -n "$API_URL" ] && [ "$API_URL" != "None" ]; then
              echo "api_url=$API_URL" >> $GITHUB_OUTPUT
            fi
            if [ -n "$WEBSITE_URL" ] && [ "$WEBSITE_URL" != "None" ]; then
              echo "website_url=$WEBSITE_URL" >> $GITHUB_OUTPUT
            fi
          fi

      - name: üìã Deployment Summary
        run: |
          echo "## üéâ Deployment Complete!" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          
          # Deployment URLs section
          echo "### üîó Deployment URLs" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          
          API_URL="${{ steps.urls.outputs.api_url }}"
          WEBSITE_URL="${{ steps.urls.outputs.website_url }}"
          
          if [ -n "$API_URL" ]; then
            echo "| üöÄ **API URL** | [$API_URL]($API_URL) |" >> $GITHUB_STEP_SUMMARY
          fi
          
          if [ -n "$WEBSITE_URL" ]; then
            echo "| üåê **Website URL** | [$WEBSITE_URL]($WEBSITE_URL) |" >> $GITHUB_STEP_SUMMARY
          fi
          
          if [ -z "$API_URL" ] && [ -z "$WEBSITE_URL" ]; then
            echo "> ‚ö†Ô∏è URLs not found in stack outputs. Check CloudFormation console." >> $GITHUB_STEP_SUMMARY
          fi
          
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### üìã Deployment Details" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "| Setting | Value |" >> $GITHUB_STEP_SUMMARY
          echo "|---------|-------|" >> $GITHUB_STEP_SUMMARY
          echo "| Environment | \`${{ github.event.inputs.environment }}\` |" >> $GITHUB_STEP_SUMMARY
          echo "| Deploy Type | \`${{ github.event.inputs.deploy_type }}\` |" >> $GITHUB_STEP_SUMMARY
          echo "| Branch | \`${{ github.ref_name }}\` |" >> $GITHUB_STEP_SUMMARY
          echo "| Commit | \`${{ github.sha }}\` |" >> $GITHUB_STEP_SUMMARY
          echo "| Triggered by | @${{ github.actor }} |" >> $GITHUB_STEP_SUMMARY
          echo "| Region | \`${{ env.AWS_REGION }}\` |" >> $GITHUB_STEP_SUMMARY
          
          # Add quick test commands
          if [ -n "$API_URL" ]; then
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "### üß™ Quick Test" >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "\`\`\`bash" >> $GITHUB_STEP_SUMMARY
            echo "# Test API health" >> $GITHUB_STEP_SUMMARY
            echo "curl ${API_URL}api/health" >> $GITHUB_STEP_SUMMARY
            echo "\`\`\`" >> $GITHUB_STEP_SUMMARY
          fi

  # Production deployment requires approval
  prod-approval:
    name: Production Approval
    if: github.event.inputs.environment == 'prod'
    runs-on: ubuntu-latest
    environment: production-approval
    steps:
      - name: ‚ö†Ô∏è Production Deployment Notice
        run: |
          echo "‚ö†Ô∏è This is a PRODUCTION deployment!"
          echo "Please review the changes carefully before approving."
